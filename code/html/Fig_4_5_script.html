
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Fig_4_5_script</title><meta name="generator" content="MATLAB 7.11"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2014-04-10"><meta name="DC.source" content="Fig_4_5_script.m"><style type="text/css">

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#1">Fig_4_5_script.m</a></li><li><a href="#2">Set working directories: directories where input data are located</a></li><li><a href="#3">User-set parameters, for SEA.m and plotting</a></li><li><a href="#4">Load data and create variables</a></li><li><a href="#5">Define response series</a></li><li><a href="#6">Interpolate and smooth response series, and calculate residuals</a></li><li><a href="#7">Manually input event dates</a></li><li><a href="#8">Create event series equal in length to interpolated series, for SEA.m</a></li><li><a href="#9">Perform SEA, using function SEA.m and SEA_CI.m</a></li><li><a href="#10">Figure 4: Time series</a></li><li><a href="#11">Figure 5: SEA results</a></li></ul></div><h2>Fig_4_5_script.m<a name="1"></a></h2><p>Make Figure 4 and Figure 5 from:   Dunnette P.V., P.E. Higuera, K.K. McLauchlan, K.M. Derr, C.E. Briles,   M.H. Keefe. 2014. Biogeochemical impacts of wildfires over four   millennia in a Rocky Mountain subalpine watershed.   New Phytologist Accepted.</p><p>Figure 4. Time series of sediment biogeochemistry and bulk density. Raw and smoothed (500-year trend; bold line) time series, with vertical solid red lines denoting high-severity catchment fires (n = 11) and vertical dashed blue lines denoting lower severity/extra local fires (n = 9) used in Superposed Epoch Analysis (SEA). Grey dots represent lower severity/extra local fires not included in the SEA (see Materials and Methods). Bulk density is abbreviated by &#8220;BlkDens.&#8221;</p><p>Figure 5. Results of Superposed Epoch Analysis (SEA). Composite residual response values (y axis) before and after high-severity catchment fires (solid red lines, left column) and lower severity/extra local fires (dashed blue lines, right column). The horizontal dashed and solid lines represent Monte Carlo-derived 99% and 95% confidence intervals, respectively. Bulk density is abbreviated by &#8220;BlkDens.&#8221;</p><p>USER CHOICES: yrCutOff: [yr BP] Years of BOTH time series to analyze. params.interpValue: [yr] Years to interpolate response series to. params.smWindow: [yr] Years to smooth response series to, for calculating                   residuals. params.eventWindow: [yr] Years to analyze, before and after events. x_lim: [yr BP] Years for plotting time series.</p><p>FILE REQUIREMENTS:   (1) CH10_biogeochemData.csv -- Biogeochemcial data from Chickaree Lk.</p><p>DEPENDENCIES:   (1) SEA.m -- Matlab function to derive composite records (P.E. Higuera)   (2) SEA_CI.m -- Matlab function to derive CIs for composite records           (P.E. Higuera)   (3) smooth.m -- Matlab function, from the Matlab curvefit toolbox.</p><p>CITATION, FILES, AND SELF-AUTHORED FUNCTIONS AVAILABLE FROM FigShare   Higuera, P.E. and P.V. Dunnette. 2014. Data, code, and   figures from Dunnette et al. 2014. figshare.   <a href="http://dx.doi.org/10.6084/m9.figshare.988687">http://dx.doi.org/10.6084/m9.figshare.988687</a></p><p>Created by: P.E. Higuera Created on: July, 2012 Updated: 12/2012; 3/2013; 6/2013; 7/2013; 8/2013; 9/2013 by P.V. Dunnette Edited: 4/2014 for publication, by P.E. Higuera</p><p>University of Idaho, PaleoEcology and Fire Ecology Lab <a href="http://www.uidaho.edu/cnr/paleoecologylab">http://www.uidaho.edu/cnr/paleoecologylab</a> <a href="mailto:phiguera@uidaho.edu">phiguera@uidaho.edu</a></p><pre class="codeinput">clear <span class="string">all</span>
</pre><h2>Set working directories: directories where input data are located<a name="2"></a></h2><pre class="codeinput">workingDir = <span class="string">'L:\4_archivedData\Dunnette_et_al_2014\CH10_biogeochem\'</span>;
startDir = pwd;     <span class="comment">% Record starting path</span>
</pre><h2>User-set parameters, for SEA.m and plotting<a name="3"></a></h2><pre class="codeinput">params.interpValue = 5 ;        <span class="comment">% [yr] Years to interpolate to</span>
params.smWindow = 500 ;         <span class="comment">% [yr] Years to smooth to</span>
params.eventWindow = [-50 75] ; <span class="comment">% [yr] Years to analyze, before and after</span>
params.bin = [round(params.eventWindow(1)/params.interpValue):<span class="keyword">...</span>
    round(params.eventWindow(2)/params.interpValue)];   <span class="comment">% Bins to use</span>
                                <span class="comment">% before and after events.</span>
params.nBoot = 1000;            <span class="comment">% Number of bootstrap resampling, for CIs.</span>
yrCutOff = [-57 4300];          <span class="comment">% [cal yr BP] Years to use in the analysis</span>
x_lim = yrCutOff;               <span class="comment">% x-axis limits for plotting</span>
</pre><h2>Load data and create variables<a name="4"></a></h2><pre class="codeinput">cd(workingDir)      <span class="comment">% Change to working directory</span>
data = csvread(<span class="string">'CH10_biogeochemData.csv'</span>,1,4);      <span class="comment">% Biogeochemical data</span>
colName = {<span class="string">'topCm'</span>;<span class="string">'botCm'</span>;<span class="string">'topAge'</span>;<span class="string">'botAge'</span>;<span class="keyword">...</span>
   [<span class="string">'\delta^1^5N ('</span> char(8240) <span class="string">')'</span>]; <span class="string">'N (%)'</span>;<span class="keyword">...</span>
   [<span class="string">'\delta^1^3C ('</span> char(8240) <span class="string">')'</span>]; <span class="string">'C (%)'</span>; <span class="string">'C:N'</span>;<span class="keyword">...</span>
   [<span class="string">'  BlkDens  '</span>;<span class="string">'(g cm^{-3})'</span>];<span class="keyword">...</span>
   [<span class="string">'      C_a_c_c      '</span> ; <span class="string">'(g cm^{-2} yr^{-1})'</span>]};    <span class="comment">% Column headers,</span>
                                                        <span class="comment">% and units</span>
cd(startDir)        <span class="comment">% Change directory back to starting directory.</span>
</pre><h2>Define response series<a name="5"></a></h2><pre class="codeinput">in = [5 9 11 8 6 10];               <span class="comment">% Index for response vars., from data</span>
response.x = mean(data(:,3:4),2);   <span class="comment">% [cal yr BP] Mid-sample age of</span>
                                    <span class="comment">% samples; redefined three lines below</span>
in2 = find([(response.x &gt;= yrCutOff(1)) .* (response.x &lt;= yrCutOff(2))]);
    <span class="comment">% Index for all samples within desired age range, defined by yrCutOff</span>
response.x = mean(data(in2,3:4),2); <span class="comment">% [cal yr BP] Mid-sample age of samples</span>
response.y = data(in2,in);          <span class="comment">% Response time series; units are in</span>
                                        <span class="comment">% params.responseName.</span>
response.n = length(in);            <span class="comment">% Number of response series.</span>
response.name = colName(in);        <span class="comment">% Name and units for each response var.</span>
</pre><h2>Interpolate and smooth response series, and calculate residuals<a name="6"></a></h2><pre class="codeinput">response.xi = [yrCutOff(1):params.interpValue:max(response.x)]';
                <span class="comment">% [cal yr BP] Interpolated x values</span>
response.yi = interp1(response.x,response.y,response.xi);   <span class="comment">% Interpolated</span>
                <span class="comment">% response series; units as in y</span>

response.ySm = NaN*ones(size(response.yi));     <span class="comment">% Space for smoothed</span>
                                                <span class="comment">% response series</span>
<span class="keyword">for</span> i = 1:response.n
    response.ySm(:,i) = smooth(response.yi(:,i),<span class="keyword">...</span><span class="comment">  % Lowess smoother,</span>
    params.smWindow/params.interpValue,<span class="string">'rlowess'</span>);  <span class="comment">% robust to outliers.</span>
<span class="keyword">end</span>

response.residuals = response.yi - response.ySm; <span class="comment">% Residuals after removing</span>
                    <span class="comment">% long-term trends from interpolated response variables</span>
</pre><h2>Manually input event dates<a name="7"></a></h2><p>Criteria for events: 99.9 percentile CHAR pks, 99.9 percentile MS pks. 75 years was the minimum allowable time between consecutive events. Coincident events at 3316 and 4179 cal yr BP were excluded, owing to their proximity to the 3262 and 4156 cal yr BP fire, respectively. Including these events did not significantly alter the results.</p><pre class="codeinput">HSCF = [161 960 1243 2124 2670 2752 2913 3262 3725 3803 4156];
    <span class="comment">% [cal yr BP] High-severity catchment fires (n = 11). Based on output</span>
    <span class="comment">% from events_ID (altered manually for more precise fire yr)</span>
    nHSCF = length(HSCF);               <span class="comment">% sample size for HSCF</span>
LSEF_hiRes = [230 521 1637 1875 2177 2508 3116 3396 3863];
    <span class="comment">% [cal yr BP] Lower severity, extra local fires (LSEF)with high</span>
    <span class="comment">% resolution analysis (n = 9)</span>
    nLSEF_hiRes = length(LSEF_hiRes);   <span class="comment">% sample size for LSEF_hiRes</span>
nonSEA_fires = [573 659 823 891 1360 1577 1890 2065 2870 2948 3316 3888,<span class="keyword">...</span>
    4081 4179];
    <span class="comment">% [cal yr BP] Fires without high-resolution analysis (n = 14). These</span>
    <span class="comment">% are only for plotting (Fig. 4) and are not used in the SEA (Fig. 5).</span>
</pre><h2>Create event series equal in length to interpolated series, for SEA.m<a name="8"></a></h2><pre class="codeinput">events = zeros(length(response.xi),2); <span class="comment">% Space for binary</span>
    <span class="comment">% event series, where 1 = event, and 0 = no event, for use in SEA.m</span>
    <span class="comment">% function. First row = HSFC, second row = LSEF_hiRes</span>
<span class="keyword">for</span> i = 1:nHSCF
    in = find(abs(response.xi - HSCF(i)) ==<span class="keyword">...</span>
            min(abs(response.xi(:,1) - HSCF(i)))); <span class="comment">% Find the index value</span>
        <span class="comment">% that minimizes the difference between the year of the event and</span>
        <span class="comment">% the closest matching year in the interpolated response series.</span>
        <span class="comment">% This accommodates event and response series with differing x</span>
        <span class="comment">% values.</span>
       events(in,1) = 1;     <span class="comment">% Make this value 1</span>
<span class="keyword">end</span>
<span class="keyword">for</span> i = 1:nLSEF_hiRes
    in = find(abs(response.xi - LSEF_hiRes(i)) ==<span class="keyword">...</span>
            min(abs(response.xi - LSEF_hiRes(i)))); <span class="comment">% Find the index</span>
        <span class="comment">% value that minimizes the difference between the year of the event</span>
        <span class="comment">% and the closest matching year in the interpolated response</span>
        <span class="comment">% series. This accommodates event and response series with differing</span>
        <span class="comment">% x values.</span>
       events(in,2) = 1;     <span class="comment">% Make this value 1</span>
<span class="keyword">end</span>
</pre><h2>Perform SEA, using function SEA.m and SEA_CI.m<a name="9"></a></h2><pre class="codeinput">params.nBoot = 10000;     <span class="comment">% Number of bootstraps for confidence intervals.</span>
params.block = 5;       <span class="comment">% [samples] Block size for resampling series for</span>
                            <span class="comment">% construction of confidence intervals</span>
x = response.xi;        <span class="comment">% Interpolated dates for response series</span>
Y = response.residuals; <span class="comment">% Perform SEA using residual values</span>

[composite] = SEA(x,Y,events,params);
        <span class="comment">% composite: Mean value across all events, for</span>
        <span class="comment">% each bin (i) before and after events, for each response</span>
        <span class="comment">% variable (j), and for each event series (k).</span>
[composite_CI] = SEA_CI(x,Y,events,params);
    <span class="comment">% composite_CI: percentile values for each bin before and after</span>
    <span class="comment">% events (i), each response series (j), each event series (k), and each</span>
    <span class="comment">% percentile level (l). Percentiles are as follows: 0.5 99.5,</span>
    <span class="comment">% corresponding to 99% CI, 2.5 and 97.5, corresponding to 95 CI, and</span>
    <span class="comment">% 5 and 95, corresponding to 90% CI&gt;</span>
</pre><h2>Figure 4: Time series<a name="10"></a></h2><pre class="codeinput">fs = 10;        <span class="comment">% Font size</span>

figure(2); clf
set(gcf,<span class="string">'color'</span>,<span class="string">'w'</span>,<span class="string">'units'</span>,<span class="string">'centimeters'</span>,<span class="string">'position'</span>,[15 0 12.35 23.35]);
<span class="keyword">for</span> i = 1:response.n
    subplot(response.n,1,i)
    plot(response.x,response.y(:,i),<span class="string">'k'</span>)    <span class="comment">% Plot response time series.</span>
    axis <span class="string">tight</span>
    y_lim = get(gca,<span class="string">'ylim'</span>);
    <span class="keyword">if</span> i == 3 <span class="comment">% If C_acc, change y-lim</span>
        y_lim = [y_lim(1) 1.8];
        ylim(y_lim)
    <span class="keyword">end</span>
    hold <span class="string">on</span>
    plot(response.xi,response.ySm(:,i),<span class="string">'k'</span>,<span class="string">'linewidth'</span>,1.5) <span class="comment">% Plot smoothed</span>
                                            <span class="comment">% response time series.</span>
    <span class="keyword">for</span> k = 1:length(HSCF)          <span class="comment">% Plot HSCF as lines</span>
        plot([HSCF(k) HSCF(k)],[y_lim(1) 0.90*y_lim(2)],<span class="string">'-r'</span>,<span class="string">'linewidth'</span>,1)
    <span class="keyword">end</span>
    <span class="keyword">for</span> k = 1:length(LSEF_hiRes)    <span class="comment">% Plot LSEF as dashed lines</span>
        plot([LSEF_hiRes(k) LSEF_hiRes(k)],[y_lim(1) 0.90*y_lim(2)],<span class="keyword">...</span>
                 <span class="string">'--b'</span>,<span class="string">'linewidth'</span>,1)
    <span class="keyword">end</span>
    plot(nonSEA_fires,0.90.*y_lim(2),<span class="string">'.'</span>,<span class="string">'color'</span>,[0.5 0.5 0.5])  <span class="comment">% Plot</span>
        <span class="comment">% fires not used in SEA as dots.</span>
    box <span class="string">off</span>
    <span class="keyword">if</span> i &lt; response.n
        set(gca,<span class="string">'xticklabel'</span>,<span class="string">''</span>)
    <span class="keyword">else</span>
        xlabel(<span class="string">'Calibrated years BP'</span>,<span class="string">'FontSize'</span>,fs,<span class="string">'FontWeight'</span>,<span class="string">'Bold'</span>)
    <span class="keyword">end</span>
    set(gca,<span class="string">'FontSize'</span>,fs,<span class="string">'FontWeight'</span>,<span class="string">'b'</span>,<span class="string">'xdir'</span>,<span class="string">'rev'</span>,<span class="string">'tickdir'</span>,<span class="string">'out'</span>,<span class="keyword">...</span>
        <span class="string">'xtick'</span>,[0:500:4000],<span class="string">'ticklength'</span>,[0.012 0.012],<span class="string">'xlim'</span>,x_lim)
    ylabel(response.name(i))
    <span class="comment">% Position the plot:</span>
    pos = get(gca,<span class="string">'position'</span>);
    pos(4) = 0.12;
    pos(1) = 0.17;
    set(gca,<span class="string">'position'</span>,pos)
<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="Fig_4_5_script_01.png" alt=""> <h2>Figure 5: SEA results<a name="11"></a></h2><pre class="codeinput">figure(3); clf
set(gcf,<span class="string">'color'</span>,<span class="string">'w'</span>,<span class="string">'units'</span>,<span class="string">'centimeters'</span>,<span class="string">'position'</span>,[25 0 12.35 23.35]);
y_lim_bc = [-0.4 0.35; -1.7 1.7; -0.1 0.2; -7 4; -0.6 0.3; -0.1 0.3];
y_tick_bc = [-999 -0.2 0 0.2; -999 -1 0 1; -999 -0.1 0 0.1; -999 -4 0 4;<span class="keyword">...</span>
    -0.4 -0.2 0 0.2; -0.1 0 0.1 0.2];
plotIn = [1:2:response.n*2];

<span class="keyword">for</span> i = 1:response.n
        <span class="comment">% Lower severity / extra local fires</span>
        subplot(response.n,2,plotIn(i)+1)
        j = 2;
        set(gca,<span class="string">'tickdir'</span>,<span class="string">'out'</span>);
        box <span class="string">off</span>
        x = params.interpValue .* params.bin;
        y = composite(:,i,j);
        hold <span class="string">on</span>
        h4 = bar(x,y,1);
        set(h4,<span class="string">'facecolor'</span>,[0.5 0.5 0.5],<span class="string">'edgecolor'</span>,[0.5 0.5 0.5])
        plot(x,squeeze(composite_CI(:,i,j,[1:2])),<span class="string">'--k'</span>)
        plot(x,squeeze(composite_CI(:,i,j,[3:4])),<span class="string">'-k'</span>)
        axis <span class="string">tight</span>
        y_lim = get(gca,<span class="string">'ylim'</span>);
        plot([0 0],y_lim_bc(i,:),<span class="string">'--b'</span>,<span class="string">'linewidth'</span>,1)
        set(gca,<span class="string">'ylim'</span>,y_lim_bc(i,:),<span class="string">'ytick'</span>,y_tick_bc(i,:),<span class="keyword">...</span>
            <span class="string">'FontSize'</span>,fs,<span class="string">'FontWeight'</span>,<span class="string">'b'</span>);
        xlim([-50 50]);
        set(gca,<span class="string">'xtick'</span>,[-50:25:50]);
        set(gca,<span class="string">'ticklength'</span>,[0.06 0.06]);
        <span class="keyword">if</span> i == 1
            title({<span class="string">'Lower severity /'</span> <span class="string">'extra local fires'</span>},<span class="keyword">...</span>
                <span class="string">'FontSize'</span>,fs,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>)
        <span class="keyword">end</span>
        pos=get(gca,<span class="string">'position'</span>);
        pos(4) = 0.11;
        pos(3) = 0.3347*0.75;
        pos(1) = 0.65;
        set(gca,<span class="string">'position'</span>,pos)

         <span class="keyword">if</span> i &lt; response.n
           set(gca,<span class="string">'xticklabel'</span>,<span class="string">''</span>)
         <span class="keyword">else</span>
            set(gca,<span class="string">'xticklabel'</span>,{<span class="string">'-50'</span>,<span class="string">''</span>,<span class="string">'0'</span>,<span class="string">''</span>,<span class="string">'50'</span>,});
         <span class="keyword">end</span>

        <span class="comment">% High severity catchment fires</span>
        subplot(response.n,2,plotIn(i))
        j = 1;
        set(gca,<span class="string">'tickdir'</span>,<span class="string">'out'</span>);
        box <span class="string">off</span>
        x = params.interpValue .* params.bin;
        y = composite(:,i,j);
        hold <span class="string">on</span>
        h4 = bar(x,y,1);
        set(h4,<span class="string">'facecolor'</span>,[0.5 0.5 0.5],<span class="string">'edgecolor'</span>,[0.5 0.5 0.5])
        plot(x,squeeze(composite_CI(:,i,j,[1:2])),<span class="string">'--k'</span>)
        plot(x,squeeze(composite_CI(:,i,j,[3:4])),<span class="string">'-k'</span>)
        axis <span class="string">tight</span>
        box <span class="string">off</span>
        set(gca,<span class="string">'ylim'</span>,y_lim_bc(i,:),<span class="string">'ytick'</span>,y_tick_bc(i,:),<span class="keyword">...</span>
            <span class="string">'xtick'</span>,[-50:25:75],<span class="string">'tickdir'</span>,<span class="string">'out'</span>,<span class="keyword">...</span>
            <span class="string">'ticklength'</span>,[0.06 0.06],<span class="string">'FontSize'</span>,fs,<span class="string">'FontWeight'</span>,<span class="string">'b'</span>);
        ylabel(response.name(i))
        pos = get(gca,<span class="string">'position'</span>);
        pos(4) = 0.11;
        pos(1) = 0.18;
        set(gca,<span class="string">'position'</span>,pos)

        <span class="keyword">if</span> i == 1
            title ({<span class="string">'High-severity'</span> <span class="string">'catchment fires'</span>},<span class="string">'fontweight'</span>,<span class="keyword">...</span>
                <span class="string">'bold'</span>,<span class="string">'FontSize'</span>,fs)
        <span class="keyword">end</span>
        <span class="keyword">if</span> i &lt; response.n
           set(gca,<span class="string">'xticklabel'</span>,<span class="string">''</span>)
        <span class="keyword">else</span>
            xlabel({<span class="string">' '</span> <span class="string">'                                                Lag (years)'</span>},<span class="keyword">...</span>
                <span class="string">'fontsize'</span>,fs,<span class="string">'fontweight'</span>,<span class="string">'b'</span>)
            set(gca,<span class="string">'xticklabel'</span>,{<span class="string">'-50'</span>,<span class="string">''</span>,<span class="string">'0'</span>,<span class="string">''</span>,<span class="string">'50'</span>,<span class="string">''</span>});
        <span class="keyword">end</span>
        set(gca,<span class="string">'xlim'</span>,[-50 75])
        plot([0 0],y_lim_bc(i,:),<span class="string">'r'</span>,<span class="string">'linewidth'</span>,1)
<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="Fig_4_5_script_02.png" alt=""> <p class="footer"><br>
      Published with MATLAB&reg; 7.11<br></p></div><!--
##### SOURCE BEGIN #####
%% Fig_4_5_script.m
%
% Make Figure 4 and Figure 5 from:
%   Dunnette P.V., P.E. Higuera, K.K. McLauchlan, K.M. Derr, C.E. Briles, 
%   M.H. Keefe. 2014. Biogeochemical impacts of wildfires over four 
%   millennia in a Rocky Mountain subalpine watershed. 
%   New Phytologist Accepted.
%
% Figure 4. Time series of sediment biogeochemistry and bulk density. Raw 
% and smoothed (500-year trend; bold line) time series, with vertical solid
% red lines denoting high-severity catchment fires (n = 11) and vertical 
% dashed blue lines denoting lower severity/extra local fires (n = 9) used 
% in Superposed Epoch Analysis (SEA). Grey dots represent lower 
% severity/extra local fires not included in the SEA (see Materials and 
% Methods). Bulk density is abbreviated by “BlkDens.”
%
% Figure 5. Results of Superposed Epoch Analysis (SEA). Composite residual
% response values (y axis) before and after high-severity catchment fires
% (solid red lines, left column) and lower severity/extra local fires
% (dashed blue lines, right column). The horizontal dashed and solid lines
% represent Monte Carlo-derived 99% and 95% confidence intervals, 
% respectively. Bulk density is abbreviated by “BlkDens.”
%
% USER CHOICES:
% yrCutOff: [yr BP] Years of BOTH time series to analyze.
% params.interpValue: [yr] Years to interpolate response series to. 
% params.smWindow: [yr] Years to smooth response series to, for calculating 
%                   residuals. 
% params.eventWindow: [yr] Years to analyze, before and after events. 
% x_lim: [yr BP] Years for plotting time series.
%
% FILE REQUIREMENTS:
%   (1) CH10_biogeochemData.csv REPLACE_WITH_DASH_DASH Biogeochemcial data from Chickaree Lk.
%
% DEPENDENCIES: 
%   (1) SEA.m REPLACE_WITH_DASH_DASH Matlab function to derive composite records (P.E. Higuera)
%   (2) SEA_CI.m REPLACE_WITH_DASH_DASH Matlab function to derive CIs for composite records 
%           (P.E. Higuera)
%   (3) smooth.m REPLACE_WITH_DASH_DASH Matlab function, from the Matlab curvefit toolbox.
%
% CITATION, FILES, AND SELF-AUTHORED FUNCTIONS AVAILABLE FROM FigShare
%   Higuera, P.E. and P.V. Dunnette. 2014. Data, code, and 
%   figures from Dunnette et al. 2014. figshare. 
%   http://dx.doi.org/10.6084/m9.figshare.988687
%
% Created by: P.E. Higuera
% Created on: July, 2012
% Updated: 12/2012; 3/2013; 6/2013; 7/2013; 8/2013; 9/2013 by P.V. Dunnette
% Edited: 4/2014 for publication, by P.E. Higuera
%
% University of Idaho, PaleoEcology and Fire Ecology Lab
% http://www.uidaho.edu/cnr/paleoecologylab
% phiguera@uidaho.edu
 
clear all
 
%% Set working directories: directories where input data are located
workingDir = 'L:\4_archivedData\Dunnette_et_al_2014\CH10_biogeochem\';
startDir = pwd;     % Record starting path
 
%% User-set parameters, for SEA.m and plotting
params.interpValue = 5 ;        % [yr] Years to interpolate to 
params.smWindow = 500 ;         % [yr] Years to smooth to
params.eventWindow = [-50 75] ; % [yr] Years to analyze, before and after 
params.bin = [round(params.eventWindow(1)/params.interpValue):...
    round(params.eventWindow(2)/params.interpValue)];   % Bins to use 
                                % before and after events.
params.nBoot = 1000;            % Number of bootstrap resampling, for CIs.
yrCutOff = [-57 4300];          % [cal yr BP] Years to use in the analysis                              
x_lim = yrCutOff;               % x-axis limits for plotting
 
%% Load data and create variables
cd(workingDir)      % Change to working directory
data = csvread('CH10_biogeochemData.csv',1,4);      % Biogeochemical data
colName = {'topCm';'botCm';'topAge';'botAge';...
   ['\delta^1^5N (' char(8240) ')']; 'N (%)';...
   ['\delta^1^3C (' char(8240) ')']; 'C (%)'; 'C:N';...
   ['  BlkDens  ';'(g cm^{-3})'];...
   ['      C_a_c_c      ' ; '(g cm^{-2} yr^{-1})']};    % Column headers, 
                                                        % and units
cd(startDir)        % Change directory back to starting directory.
 
%% Define response series
in = [5 9 11 8 6 10];               % Index for response vars., from data
response.x = mean(data(:,3:4),2);   % [cal yr BP] Mid-sample age of 
                                    % samples; redefined three lines below
in2 = find([(response.x >= yrCutOff(1)) .* (response.x <= yrCutOff(2))]);
    % Index for all samples within desired age range, defined by yrCutOff   
response.x = mean(data(in2,3:4),2); % [cal yr BP] Mid-sample age of samples
response.y = data(in2,in);          % Response time series; units are in 
                                        % params.responseName.  
response.n = length(in);            % Number of response series. 
response.name = colName(in);        % Name and units for each response var.

%% Interpolate and smooth response series, and calculate residuals
response.xi = [yrCutOff(1):params.interpValue:max(response.x)]';
                % [cal yr BP] Interpolated x values
response.yi = interp1(response.x,response.y,response.xi);   % Interpolated 
                % response series; units as in y
 
response.ySm = NaN*ones(size(response.yi));     % Space for smoothed 
                                                % response series
for i = 1:response.n
    response.ySm(:,i) = smooth(response.yi(:,i),...  % Lowess smoother, 
    params.smWindow/params.interpValue,'rlowess');  % robust to outliers. 
end
 
response.residuals = response.yi - response.ySm; % Residuals after removing 
                    % long-term trends from interpolated response variables
                   
%% Manually input event dates
% Criteria for events: 99.9 percentile CHAR pks, 99.9 percentile MS pks. 
% 75 years was the minimum allowable time between consecutive events. 
% Coincident events at 3316 and 4179 cal yr BP were excluded, owing to 
% their proximity to the 3262 and 4156 cal yr BP fire, respectively. 
% Including these events did not significantly alter the results. 

HSCF = [161 960 1243 2124 2670 2752 2913 3262 3725 3803 4156]; 
    % [cal yr BP] High-severity catchment fires (n = 11). Based on output 
    % from events_ID (altered manually for more precise fire yr)
    nHSCF = length(HSCF);               % sample size for HSCF    
LSEF_hiRes = [230 521 1637 1875 2177 2508 3116 3396 3863];
    % [cal yr BP] Lower severity, extra local fires (LSEF)with high 
    % resolution analysis (n = 9)
    nLSEF_hiRes = length(LSEF_hiRes);   % sample size for LSEF_hiRes
nonSEA_fires = [573 659 823 891 1360 1577 1890 2065 2870 2948 3316 3888,...
    4081 4179]; 
    % [cal yr BP] Fires without high-resolution analysis (n = 14). These
    % are only for plotting (Fig. 4) and are not used in the SEA (Fig. 5).
 
%% Create event series equal in length to interpolated series, for SEA.m 
events = zeros(length(response.xi),2); % Space for binary
    % event series, where 1 = event, and 0 = no event, for use in SEA.m 
    % function. First row = HSFC, second row = LSEF_hiRes
for i = 1:nHSCF
    in = find(abs(response.xi - HSCF(i)) ==...
            min(abs(response.xi(:,1) - HSCF(i)))); % Find the index value
        % that minimizes the difference between the year of the event and
        % the closest matching year in the interpolated response series. 
        % This accommodates event and response series with differing x 
        % values. 
       events(in,1) = 1;     % Make this value 1
end
for i = 1:nLSEF_hiRes
    in = find(abs(response.xi - LSEF_hiRes(i)) ==...
            min(abs(response.xi - LSEF_hiRes(i)))); % Find the index 
        % value that minimizes the difference between the year of the event
        % and the closest matching year in the interpolated response 
        % series. This accommodates event and response series with differing 
        % x values. 
       events(in,2) = 1;     % Make this value 1
end
 
%% Perform SEA, using function SEA.m and SEA_CI.m
params.nBoot = 10000;     % Number of bootstraps for confidence intervals.
params.block = 5;       % [samples] Block size for resampling series for 
                            % construction of confidence intervals
x = response.xi;        % Interpolated dates for response series
Y = response.residuals; % Perform SEA using residual values
 
[composite] = SEA(x,Y,events,params); 
        % composite: Mean value across all events, for 
        % each bin (i) before and after events, for each response 
        % variable (j), and for each event series (k).    
[composite_CI] = SEA_CI(x,Y,events,params);  
    % composite_CI: percentile values for each bin before and after
    % events (i), each response series (j), each event series (k), and each
    % percentile level (l). Percentiles are as follows: 0.5 99.5, 
    % corresponding to 99% CI, 2.5 and 97.5, corresponding to 95 CI, and 
    % 5 and 95, corresponding to 90% CI> 
 
%% Figure 4: Time series
fs = 10;        % Font size

figure(2); clf
set(gcf,'color','w','units','centimeters','position',[15 0 12.35 23.35]); 
for i = 1:response.n
    subplot(response.n,1,i)
    plot(response.x,response.y(:,i),'k')    % Plot response time series.
    axis tight
    y_lim = get(gca,'ylim');
    if i == 3 % If C_acc, change y-lim
        y_lim = [y_lim(1) 1.8];
        ylim(y_lim)
    end
    hold on
    plot(response.xi,response.ySm(:,i),'k','linewidth',1.5) % Plot smoothed
                                            % response time series. 
    for k = 1:length(HSCF)          % Plot HSCF as lines
        plot([HSCF(k) HSCF(k)],[y_lim(1) 0.90*y_lim(2)],'-r','linewidth',1)
    end
    for k = 1:length(LSEF_hiRes)    % Plot LSEF as dashed lines
        plot([LSEF_hiRes(k) LSEF_hiRes(k)],[y_lim(1) 0.90*y_lim(2)],...
                 'REPLACE_WITH_DASH_DASHb','linewidth',1)
    end           
    plot(nonSEA_fires,0.90.*y_lim(2),'.','color',[0.5 0.5 0.5])  % Plot 
        % fires not used in SEA as dots.     
    box off
    if i < response.n
        set(gca,'xticklabel','')
    else
        xlabel('Calibrated years BP','FontSize',fs,'FontWeight','Bold')
    end
    set(gca,'FontSize',fs,'FontWeight','b','xdir','rev','tickdir','out',...
        'xtick',[0:500:4000],'ticklength',[0.012 0.012],'xlim',x_lim)
    ylabel(response.name(i))
    % Position the plot:
    pos = get(gca,'position');
    pos(4) = 0.12;
    pos(1) = 0.17;
    set(gca,'position',pos)    
end
 
%% Figure 5: SEA results
figure(3); clf
set(gcf,'color','w','units','centimeters','position',[25 0 12.35 23.35]); 
y_lim_bc = [-0.4 0.35; -1.7 1.7; -0.1 0.2; -7 4; -0.6 0.3; -0.1 0.3];
y_tick_bc = [-999 -0.2 0 0.2; -999 -1 0 1; -999 -0.1 0 0.1; -999 -4 0 4;...
    -0.4 -0.2 0 0.2; -0.1 0 0.1 0.2];
plotIn = [1:2:response.n*2];  
 
for i = 1:response.n
        % Lower severity / extra local fires
        subplot(response.n,2,plotIn(i)+1)
        j = 2;  
        set(gca,'tickdir','out');
        box off
        x = params.interpValue .* params.bin;
        y = composite(:,i,j);  
        hold on
        h4 = bar(x,y,1);
        set(h4,'facecolor',[0.5 0.5 0.5],'edgecolor',[0.5 0.5 0.5])
        plot(x,squeeze(composite_CI(:,i,j,[1:2])),'REPLACE_WITH_DASH_DASHk')
        plot(x,squeeze(composite_CI(:,i,j,[3:4])),'-k')
        axis tight 
        y_lim = get(gca,'ylim');    
        plot([0 0],y_lim_bc(i,:),'REPLACE_WITH_DASH_DASHb','linewidth',1)
        set(gca,'ylim',y_lim_bc(i,:),'ytick',y_tick_bc(i,:),...
            'FontSize',fs,'FontWeight','b');
        xlim([-50 50]);
        set(gca,'xtick',[-50:25:50]);
        set(gca,'ticklength',[0.06 0.06]);
        if i == 1
            title({'Lower severity /' 'extra local fires'},...
                'FontSize',fs,'FontWeight','bold')
        end
        pos=get(gca,'position');
        pos(4) = 0.11;
        pos(3) = 0.3347*0.75;
        pos(1) = 0.65;
        set(gca,'position',pos)
     
         if i < response.n
           set(gca,'xticklabel','')           
         else
            set(gca,'xticklabel',{'-50','','0','','50',});
         end
 
        % High severity catchment fires
        subplot(response.n,2,plotIn(i))
        j = 1;
        set(gca,'tickdir','out');
        box off
        x = params.interpValue .* params.bin;
        y = composite(:,i,j);  
        hold on
        h4 = bar(x,y,1);
        set(h4,'facecolor',[0.5 0.5 0.5],'edgecolor',[0.5 0.5 0.5])
        plot(x,squeeze(composite_CI(:,i,j,[1:2])),'REPLACE_WITH_DASH_DASHk')
        plot(x,squeeze(composite_CI(:,i,j,[3:4])),'-k')
        axis tight
        box off
        set(gca,'ylim',y_lim_bc(i,:),'ytick',y_tick_bc(i,:),...
            'xtick',[-50:25:75],'tickdir','out',...
            'ticklength',[0.06 0.06],'FontSize',fs,'FontWeight','b');
        ylabel(response.name(i))
        pos = get(gca,'position');
        pos(4) = 0.11;
        pos(1) = 0.18;
        set(gca,'position',pos)
 
        if i == 1
            title ({'High-severity' 'catchment fires'},'fontweight',...
                'bold','FontSize',fs)
        end
        if i < response.n
           set(gca,'xticklabel','')
        else
            xlabel({' ' '                                                Lag (years)'},...
                'fontsize',fs,'fontweight','b')
            set(gca,'xticklabel',{'-50','','0','','50',''});
        end
        set(gca,'xlim',[-50 75])
        plot([0 0],y_lim_bc(i,:),'r','linewidth',1)
end

##### SOURCE END #####
--></body></html>