
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Fig_6_S4_script</title><meta name="generator" content="MATLAB 7.11"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2014-04-10"><meta name="DC.source" content="Fig_6_S4_script.m"><style type="text/css">

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#1">Fig_6_S4_script.m</a></li><li><a href="#2">Set working directories: directories where input data are located</a></li><li><a href="#3">User-set parameters, for SEA.m and plotting</a></li><li><a href="#4">Load data and create variables</a></li><li><a href="#5">Define response series</a></li><li><a href="#6">Interpolate and smooth response series, and calculate residuals</a></li><li><a href="#7">Manually input event dates and index for peak magnitude values</a></li><li><a href="#8">Create event series equal in length to interpolated series</a></li><li><a href="#9">Create series for correlations, HSCF</a></li><li><a href="#10">Create series for correlations, LSEF_hiRes</a></li><li><a href="#11">Plot results</a></li></ul></div><h2>Fig_6_S4_script.m<a name="1"></a></h2><p>Make Figure 6 and Figure S4 from: Dunnette P.V., P.E. Higuera, K.K. McLauchlan, K.M. Derr, C.E. Briles, M.H. Keefe. 2014. Biogeochemical impacts of wildfires over four millennia in a Rocky Mountain subalpine watershed. New Phytologist Accepted.</p><p>Figure 6. Relationships between charcoal peak magnitude and the proxy responses following high-severity catchment fires. Pearson correlation coefficients (r) were calculated using the log-transformed peak magnitude of each fire event and mean residual response variable values ~0-20 years (left column) and ~20-50 years (right column) after each event. Bulk density is abbreviated by &#8220;BlkDens.&#8221;</p><p>Fig. S4. Relationships between charcoal peak magnitude and proxy responses for lower severity/extra local fires. Pearson correlation coefficients (r) were calculated using the log-transformed peak magnitude of each fire event and mean residual response variable values ~0-20 years (left column) and ~20-50 years (right column) after each event. Compare to Fig. 6 in the main text.</p><p>FILE REQUIREMENTS:   (1) CH10_biogeochemData.csv -- Biogeochemcial data from Chickaree Lk.   (2) CH10_charResults.csv -- CharAnalysis results from Chickaree Lk.</p><p>DEPENDENCIES:   (1) smooth.m -- Matlab function in the curvefit toolbox   (2) corr.m -- Matlab function in the statistics toolbox   (3) regress.m -- Matlab function in the statistics toolbox</p><p>CITATION, FILES, AND SELF-AUTHORED FUNCTIONS AVAILABLE FROM FigShare   Higuera, P.E. and P.V. Dunnette. 2014. Data, code, and   figures from Dunnette et al. 2014. figshare.   <a href="http://dx.doi.org/10.6084/m9.figshare.988687">http://dx.doi.org/10.6084/m9.figshare.988687</a></p><p>Created by: P.V. Dunnette Created on: March, 2013 Updated: May, June, 2013, by PVD Edited: 25 Jan., 2013, by P.E. Higuera Edited: April, 2014, edited for publication by P.E. Higuera</p><p>University of Idaho, PaleoEcology and Fire Ecology Lab <a href="http://www.uidaho.edu/cnr/paleoecologylab">http://www.uidaho.edu/cnr/paleoecologylab</a> <a href="mailto:phiguera@uidaho.edu">phiguera@uidaho.edu</a></p><pre class="codeinput">clear <span class="string">all</span>
</pre><h2>Set working directories: directories where input data are located<a name="2"></a></h2><pre class="codeinput"><span class="comment">%%%% IF ALL FILES ARE LOCATED IN THE SAME DIRECTORY AS THIS SCRIPT, CHANGE</span>
<span class="comment">%%%% workdingDir to 'pwd'</span>
startDir = pwd;     <span class="comment">% Record starting path</span>
workingDir = <span class="string">'L:\4_archivedData\Dunnette_et_al_2014\CH10_biogeochem\'</span>;
workingDir2 = <span class="string">'L:\4_archivedData\Dunnette_et_al_2014\CH10_charcoal\'</span>;
</pre><h2>User-set parameters, for SEA.m and plotting<a name="3"></a></h2><pre class="codeinput">params.interpValue = 5 ;        <span class="comment">% [yr] Years to interpolate to</span>
params.smWindow = 500 ;         <span class="comment">% [yr] Years to smooth to</span>
yrCutOff = [-57 4300];          <span class="comment">% [cal yr BP] Years to use in the analysis</span>
</pre><h2>Load data and create variables<a name="4"></a></h2><pre class="codeinput">cd(workingDir)      <span class="comment">% Change to working directory</span>
data = csvread(<span class="string">'CH10_biogeochemData.csv'</span>,1,4);      <span class="comment">% Biogeochemical data</span>
colName = {<span class="string">'topCm'</span>;<span class="string">'botCm'</span>;<span class="string">'topAge'</span>;<span class="string">'botAge'</span>;<span class="keyword">...</span>
   [<span class="string">'\delta^1^5N ('</span> char(8240) <span class="string">')'</span>]; <span class="string">'N (%)'</span>;<span class="keyword">...</span>
   [<span class="string">'\delta^1^3C ('</span> char(8240) <span class="string">')'</span>]; <span class="string">'C (%)'</span>; <span class="string">'C:N'</span>;<span class="keyword">...</span>
   [<span class="string">'  BlkDens  '</span>;<span class="string">'(g cm^{-3})'</span>];<span class="keyword">...</span>
   [<span class="string">'      C_a_c_c      '</span> ; <span class="string">'(g cm^{-2} yr^{-1})'</span>]};    <span class="comment">% Column headers,</span>
                                                        <span class="comment">% and units</span>
cd(workingDir2)
charData = csvread(<span class="string">'CH10_charResults.csv'</span>,1,0);
peakMag = charData(:,21);   <span class="comment">% [#/cm^2] Peak magnitudes</span>
charYbp = charData(:,2);<span class="comment">%-0.5*mean(diff(charData(:,2)));  % [cal yr BP]</span>
                                            <span class="comment">% Mid-depth interpolated age</span>

cd(startDir)        <span class="comment">% Change directory back to starting directory.</span>
</pre><h2>Define response series<a name="5"></a></h2><pre class="codeinput">in = [5 9 8 6 10];                  <span class="comment">% Index for response vars., from data</span>
response.x = mean(data(:,3:4),2);   <span class="comment">% [cal yr BP] Mid-sample age of</span>
                                    <span class="comment">% samples; redefined three lines below</span>
in2 = find([(response.x &gt;= yrCutOff(1)) .* (response.x &lt;= yrCutOff(2))]);
    <span class="comment">% Index for all samples within desired age range, defined by yrCutOff</span>
response.x = mean(data(in2,3:4),2); <span class="comment">% [cal yr BP] Mid-sample age of samples</span>
response.y = data(in2,in);          <span class="comment">% Response time series; units are in</span>
                                        <span class="comment">% params.responseName.</span>
response.n = length(in);            <span class="comment">% Number of response series.</span>
response.name = colName(in);        <span class="comment">% Name and units for each response var.</span>
</pre><h2>Interpolate and smooth response series, and calculate residuals<a name="6"></a></h2><pre class="codeinput">response.xi = [yrCutOff(1):params.interpValue:max(response.x)]';
                <span class="comment">% [cal yr BP] Interpolated x values</span>
response.yi = interp1(response.x,response.y,response.xi);   <span class="comment">% Interpolated</span>
                <span class="comment">% response series; units as in y</span>

response.ySm = NaN*ones(size(response.yi));     <span class="comment">% Space for smoothed</span>
                                                <span class="comment">% response series</span>
<span class="keyword">for</span> i = 1:response.n
    response.ySm(:,i) = smooth(response.yi(:,i),<span class="keyword">...</span><span class="comment">  % Lowess smoother,</span>
    params.smWindow/params.interpValue,<span class="string">'rlowess'</span>);  <span class="comment">% robust to outliers.</span>
<span class="keyword">end</span>

response.residuals = response.yi - response.ySm; <span class="comment">% Residuals after removing</span>
                    <span class="comment">% long-term trends from interpolated response variables</span>
</pre><h2>Manually input event dates and index for peak magnitude values<a name="7"></a></h2><p>Criteria for events: 99.9 percentile CHAR pks, 99.9 percentile MS pks. 75 years was the minimum allowable time between consecutive events. Coincident events at 3316 and 4179 cal yr BP were excluded, owing to their proximity to the 3262 and 4156 cal yr BP fire, respectively. Including these events did not significantly alter the results.</p><p>Index finds peak magnitude value that is closest to the event.</p><pre class="codeinput">HSCFin = [23 102 131 219 274 282 297 333 379 386 422];  <span class="comment">% Index for</span>
        <span class="comment">% HSCF, defined by CharAnalysis output, in Fig_3_script.m.</span>
    nHSCF = length(HSCFin);               <span class="comment">% sample size for HSCF</span>
    HSCF = [161 960 1243 2124 2670 2752 2913 3262 3725 3803 4156];
    <span class="comment">% [cal yr BP] High-severity catchment fires (n = 11). Based on output</span>
    <span class="comment">% from Fig_3_script.m and altered manually for more precise fire yr.</span>
    <span class="comment">% Used for Fig. 6</span>

LSEF_hiResIn = [30 59 170 194 224 257 318 346 393];  <span class="comment">% Index for</span>
        <span class="comment">% LSEF_hiRes, defined by CharAnalysis output, in Fig_4_5_script.m.</span>
    nLSEF_hiRes = length(LSEF_hiResIn);   <span class="comment">% sample size for LSEF_hiRes</span>
    LSEF_hiRes = [230 521 1637 1875 2177 2508 3116 3396 3863];
    <span class="comment">% [cal yr BP] Lower severity, extra local fires (LSEF) with high</span>
    <span class="comment">% resolution analysis (n = 9)</span>
    <span class="comment">% Used for Fig. S4</span>
</pre><h2>Create event series equal in length to interpolated series<a name="8"></a></h2><pre class="codeinput">events = zeros(length(response.xi),2); <span class="comment">% Space for binary</span>
    <span class="comment">% event series, where 1 = event, and 0 = no event, First row = HSFC,</span>
    <span class="comment">% second row = LSEF_hiRes</span>
<span class="keyword">for</span> i = 1:nHSCF
    in = find(abs(response.xi - HSCF(i)) ==<span class="keyword">...</span>
            min(abs(response.xi(:,1) - HSCF(i)))); <span class="comment">% Find the index value</span>
        <span class="comment">% that minimizes the difference between the year of the event and</span>
        <span class="comment">% the closest matching year in the interpolated response series.</span>
        <span class="comment">% This accommodates event and response series with differing x</span>
        <span class="comment">% values.</span>
       events(in,1) = 1;     <span class="comment">% Make this value 1</span>
<span class="keyword">end</span>
<span class="keyword">for</span> i = 1:nLSEF_hiRes
    in = find(abs(response.xi - LSEF_hiRes(i)) ==<span class="keyword">...</span>
            min(abs(response.xi - LSEF_hiRes(i)))); <span class="comment">% Find the index</span>
        <span class="comment">% value that minimizes the difference between the year of the event</span>
        <span class="comment">% and the closest matching year in the interpolated response</span>
        <span class="comment">% series. This accommodates event and response series with differing</span>
        <span class="comment">% x values.</span>
       events(in,2) = 1;     <span class="comment">% Make this value 1</span>
<span class="keyword">end</span>
</pre><h2>Create series for correlations, HSCF<a name="9"></a></h2><pre class="codeinput">x = peakMag(HSCFin);    <span class="comment">% [#/cm^2] Peak magnitude, for peaks associated</span>
                        <span class="comment">% with high severity catchment fires.</span>

y = NaN(length(x),response.n,2);    <span class="comment">% Space for response variables, where</span>
                        <span class="comment">% i = average response to each event, and j =</span>
                        <span class="comment">% temporal window (0-20 yr for j = 1, 20-50 for</span>
                        <span class="comment">% j = 3).</span>
responseIn = find(events(:,1)); <span class="comment">% Index for events, in response variables.</span>
eventBin1 = [-3:0];     <span class="comment">% Sampling window, 0-20 yr (negative = post-fire)</span>
eventBin2 = [-9:-4];    <span class="comment">% Sampling window, 20-50 yr post fire.</span>
<span class="keyword">for</span> i = 1:length(x)
    in1 = [responseIn(i) + eventBin1];  <span class="comment">% Index for 0-20 yr post fire</span>
    in2 = [responseIn(i) + eventBin2];  <span class="comment">% Index for 20-50 yr post fire</span>
    y(i,:,1) = mean(response.residuals(in1,:));
    y(i,:,2) = mean(response.residuals(in2,:));
<span class="keyword">end</span>
</pre><h2>Create series for correlations, LSEF_hiRes<a name="10"></a></h2><pre class="codeinput">x2 = peakMag(LSEF_hiResIn); <span class="comment">% [#/cm^2] Peak magnitude, for peaks associated</span>
                            <span class="comment">% with lower severity, extra local fires.</span>

y2 = NaN(length(x2),response.n,2);    <span class="comment">% Space for response variables, where</span>
                        <span class="comment">% i = average response to each event, and j =</span>
                        <span class="comment">% temporal window (0-20 yr for j = 1, 20-50 for</span>
                        <span class="comment">% j = 3).</span>
responseIn = find(events(:,2)); <span class="comment">% Index for events, in response variables.</span>
eventBin1 = [-3:0];     <span class="comment">% Sampling window, 0-20 yr (negative = post-fire)</span>
eventBin2 = [-9:-4];    <span class="comment">% Sampling window, 20-50 yr post fire.</span>
<span class="keyword">for</span> i = 1:length(x2)
    in1 = [responseIn(i) + eventBin1];  <span class="comment">% Index for 0-20 yr post fire</span>
    in2 = [responseIn(i) + eventBin2];  <span class="comment">% Index for 20-50 yr post fire</span>
    y2(i,:,1) = mean(response.residuals(in1,:));
    y2(i,:,2) = mean(response.residuals(in2,:));
<span class="keyword">end</span>
</pre><h2>Plot results<a name="11"></a></h2><pre class="codeinput">fs = 10;                        <span class="comment">% Font size for figures</span>
subplotIn = [1:2:response.n*2]; <span class="comment">% Index for subplots</span>

<span class="keyword">for</span> k = 1:2             <span class="comment">% For HSCF and for LSEF_hiRes</span>
    <span class="keyword">if</span> k == 1
        figure(6)
        set(gcf,<span class="string">'color'</span>,<span class="string">'w'</span>,<span class="string">'units'</span>,<span class="string">'centimeters'</span>,<span class="string">'position'</span>,[5 0 11 20]);
        xPlot = x;
        yPlot = y;
        x_lim = ([1 10000]);            <span class="comment">% x-axis limit</span>
        x_tick = [1 100 10000];         <span class="comment">% x-axis tick marks</span>
    <span class="keyword">else</span>
        figure(7)
        set(gcf,<span class="string">'color'</span>,<span class="string">'w'</span>,<span class="string">'units'</span>,<span class="string">'centimeters'</span>,<span class="string">'position'</span>,[5 0 11 20]);
        xPlot = x2;
        yPlot = y2;
        x_lim = ([1 100]);              <span class="comment">% x-axis limit</span>
        x_tick = [1 10 100];            <span class="comment">% x-axis tick marks</span>
    <span class="keyword">end</span>

<span class="keyword">for</span> j = 1:response.n    <span class="comment">% For each response variable...</span>
    <span class="keyword">for</span> i = 1:2         <span class="comment">% For each time window post fire...</span>
        <span class="comment">% Select subplot</span>
        <span class="keyword">if</span> i == 1
            subplot(response.n,2,subplotIn(j))
        <span class="keyword">else</span>
            subplot(response.n,2,subplotIn(j)+1)
        <span class="keyword">end</span>

        <span class="comment">% Pearson correlation coefficient for x vs. y:</span>
        [rho,p] = corr(log(xPlot),yPlot(:,j,i));
        b = regress(yPlot(:,j,i),[ones(size(xPlot)),log(xPlot)]);
        xHat = [min(log(xPlot)), max(log(xPlot))];  <span class="comment">% Predicted x-values</span>
        yHat = b(1) + b(2).*xHat;           <span class="comment">% Predicted y-values</span>

        <span class="comment">% Plot x and y, with x-axis on log scale:</span>
        semilogx(xPlot,yPlot(:,j,i),<span class="string">'ok'</span>)
        hold <span class="string">on</span>
        <span class="keyword">if</span> p &lt; 0.05 <span class="comment">% If correlation is significant, plot best-fit line</span>
            semilogx(exp(xHat),yHat,<span class="string">'-k'</span>)
        <span class="keyword">end</span>

        <span class="comment">% Set axis properties:</span>
        y_lim = [min(yPlot(:,j,i))-0.25*range(yPlot(:,j,i))<span class="keyword">...</span>
            max(yPlot(:,j,i))+0.25*range(yPlot(:,j,i))];
        set(gca,<span class="string">'xtick'</span>,x_tick,<span class="string">'ylim'</span>,y_lim,<span class="keyword">...</span>
            <span class="string">'FontSize'</span>,fs',<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'tickdir'</span>,<span class="string">'out'</span>,<span class="keyword">...</span>
            <span class="string">'ticklength'</span>,[0.05 0.1],<span class="string">'xlim'</span>,x_lim)
        y_tick = get(gca,<span class="string">'ytick'</span>);
        <span class="keyword">if</span> length(y_tick) &gt; 3
            y_tick = [min(y_tick) min(y_tick)+0.5*range(y_tick) max(y_tick)];
            set(gca,<span class="string">'ytick'</span>,y_tick)
        <span class="keyword">end</span>
        axis <span class="string">square</span>
        box <span class="string">off</span>

        <span class="comment">% Titles and labels:</span>
        title({[<span class="string">'r = '</span> num2str(round(rho*100)/100) <span class="string">'; p = '</span> num2str(round(p*1000)/1000)]},<span class="keyword">...</span>
            <span class="string">'FontSize'</span>, fs-2)
        <span class="keyword">if</span> i == 1
            ylabel(response.name(j),<span class="string">'fontsize'</span>,fs,<span class="string">'FontWeight'</span>,<span class="string">'Bold'</span>)
        <span class="keyword">end</span>
        <span class="keyword">if</span> j &lt; response.n
            set(gca,<span class="string">'xticklabel'</span>,<span class="string">' '</span>,<span class="string">'FontWeight'</span>,<span class="string">'Bold'</span>)
        <span class="keyword">end</span>
        <span class="comment">% Change size of subplot:</span>
        p = get(gca,<span class="string">'position'</span>);
        p(4) = p(4)+0.0025;
        p(3) = 0.3347;
        <span class="keyword">if</span> i == 1
            p(1) = p(1)+0.075;
        <span class="keyword">end</span>
        set(gca,<span class="string">'position'</span>,p);

        <span class="comment">% Place column title above row 1</span>
        <span class="keyword">if</span> j == 1
            <span class="keyword">if</span> i == 1
                text(x_lim(1),y_lim(2)+0.4*range(y_lim),<span class="keyword">...</span>
                    <span class="string">'0-20 yr postfire'</span>,<span class="string">'HorizontalAlignment'</span>,<span class="keyword">...</span>
                    <span class="string">'Left'</span>,<span class="string">'FontSize'</span>,fs,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
            <span class="keyword">else</span>
                text(x_lim(1),y_lim(2)+0.4*range(y_lim),<span class="keyword">...</span>
                    <span class="string">'20-50 yr postfire'</span>,<span class="string">'HorizontalAlignment'</span>,<span class="keyword">...</span>
                    <span class="string">'Left'</span>,<span class="string">'FontSize'</span>,fs,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>     <span class="comment">% End loop for each time window</span>
<span class="keyword">end</span>         <span class="comment">% End loop for each variable</span>
xlabel(<span class="string">'Charcoal peak magnitude (# cm^{-2})                                          '</span>,<span class="keyword">...</span>
    <span class="string">'FontSize'</span>,fs,<span class="string">'FontWeight'</span>,<span class="string">'b'</span>)
<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="Fig_6_S4_script_01.png" alt=""> <img vspace="5" hspace="5" src="Fig_6_S4_script_02.png" alt=""> <p class="footer"><br>
      Published with MATLAB&reg; 7.11<br></p></div><!--
##### SOURCE BEGIN #####
%% Fig_6_S4_script.m
%
% Make Figure 6 and Figure S4 from:
% Dunnette P.V., P.E. Higuera, K.K. McLauchlan, K.M. Derr, C.E. Briles, 
% M.H. Keefe. 2014. Biogeochemical impacts of wildfires over four millennia 
% in a Rocky Mountain subalpine watershed. New Phytologist Accepted.
%
% Figure 6. Relationships between charcoal peak magnitude and the proxy 
% responses following high-severity catchment fires. Pearson correlation 
% coefficients (r) were calculated using the log-transformed peak magnitude
% of each fire event and mean residual response variable values ~0-20 years
% (left column) and ~20-50 years (right column) after each event. Bulk 
% density is abbreviated by “BlkDens.”
%
% Fig. S4. Relationships between charcoal peak magnitude and proxy 
% responses for lower severity/extra local fires. Pearson correlation
% coefficients (r) were calculated using the log-transformed peak magnitude
% of each fire event and mean residual response variable values ~0-20 years
% (left column) and ~20-50 years (right column) after each event. Compare 
% to Fig. 6 in the main text. 
%
% FILE REQUIREMENTS:
%   (1) CH10_biogeochemData.csv REPLACE_WITH_DASH_DASH Biogeochemcial data from Chickaree Lk.
%   (2) CH10_charResults.csv REPLACE_WITH_DASH_DASH CharAnalysis results from Chickaree Lk.
%
% DEPENDENCIES: 
%   (1) smooth.m REPLACE_WITH_DASH_DASH Matlab function in the curvefit toolbox
%   (2) corr.m REPLACE_WITH_DASH_DASH Matlab function in the statistics toolbox
%   (3) regress.m REPLACE_WITH_DASH_DASH Matlab function in the statistics toolbox
%
% CITATION, FILES, AND SELF-AUTHORED FUNCTIONS AVAILABLE FROM FigShare
%   Higuera, P.E. and P.V. Dunnette. 2014. Data, code, and 
%   figures from Dunnette et al. 2014. figshare. 
%   http://dx.doi.org/10.6084/m9.figshare.988687
%
% Created by: P.V. Dunnette
% Created on: March, 2013
% Updated: May, June, 2013, by PVD
% Edited: 25 Jan., 2013, by P.E. Higuera
% Edited: April, 2014, edited for publication by P.E. Higuera
%
% University of Idaho, PaleoEcology and Fire Ecology Lab
% http://www.uidaho.edu/cnr/paleoecologylab
% phiguera@uidaho.edu

clear all

%% Set working directories: directories where input data are located
%%%% IF ALL FILES ARE LOCATED IN THE SAME DIRECTORY AS THIS SCRIPT, CHANGE
%%%% workdingDir to 'pwd'
startDir = pwd;     % Record starting path
workingDir = 'L:\4_archivedData\Dunnette_et_al_2014\CH10_biogeochem\';
workingDir2 = 'L:\4_archivedData\Dunnette_et_al_2014\CH10_charcoal\';

%% User-set parameters, for SEA.m and plotting
params.interpValue = 5 ;        % [yr] Years to interpolate to 
params.smWindow = 500 ;         % [yr] Years to smooth to
yrCutOff = [-57 4300];          % [cal yr BP] Years to use in the analysis                              
 
%% Load data and create variables
cd(workingDir)      % Change to working directory
data = csvread('CH10_biogeochemData.csv',1,4);      % Biogeochemical data
colName = {'topCm';'botCm';'topAge';'botAge';...
   ['\delta^1^5N (' char(8240) ')']; 'N (%)';...
   ['\delta^1^3C (' char(8240) ')']; 'C (%)'; 'C:N';...
   ['  BlkDens  ';'(g cm^{-3})'];...
   ['      C_a_c_c      ' ; '(g cm^{-2} yr^{-1})']};    % Column headers, 
                                                        % and units
cd(workingDir2)
charData = csvread('CH10_charResults.csv',1,0);
peakMag = charData(:,21);   % [#/cm^2] Peak magnitudes
charYbp = charData(:,2);%-0.5*mean(diff(charData(:,2)));  % [cal yr BP]
                                            % Mid-depth interpolated age

cd(startDir)        % Change directory back to starting directory.

%% Define response series
in = [5 9 8 6 10];                  % Index for response vars., from data
response.x = mean(data(:,3:4),2);   % [cal yr BP] Mid-sample age of 
                                    % samples; redefined three lines below
in2 = find([(response.x >= yrCutOff(1)) .* (response.x <= yrCutOff(2))]);
    % Index for all samples within desired age range, defined by yrCutOff   
response.x = mean(data(in2,3:4),2); % [cal yr BP] Mid-sample age of samples
response.y = data(in2,in);          % Response time series; units are in 
                                        % params.responseName.  
response.n = length(in);            % Number of response series. 
response.name = colName(in);        % Name and units for each response var.

%% Interpolate and smooth response series, and calculate residuals
response.xi = [yrCutOff(1):params.interpValue:max(response.x)]';
                % [cal yr BP] Interpolated x values
response.yi = interp1(response.x,response.y,response.xi);   % Interpolated 
                % response series; units as in y
 
response.ySm = NaN*ones(size(response.yi));     % Space for smoothed 
                                                % response series
for i = 1:response.n
    response.ySm(:,i) = smooth(response.yi(:,i),...  % Lowess smoother, 
    params.smWindow/params.interpValue,'rlowess');  % robust to outliers. 
end
 
response.residuals = response.yi - response.ySm; % Residuals after removing 
                    % long-term trends from interpolated response variables
                   
%% Manually input event dates and index for peak magnitude values
% Criteria for events: 99.9 percentile CHAR pks, 99.9 percentile MS pks. 
% 75 years was the minimum allowable time between consecutive events. 
% Coincident events at 3316 and 4179 cal yr BP were excluded, owing to 
% their proximity to the 3262 and 4156 cal yr BP fire, respectively. 
% Including these events did not significantly alter the results.
%
% Index finds peak magnitude value that is closest to the event. 
HSCFin = [23 102 131 219 274 282 297 333 379 386 422];  % Index for 
        % HSCF, defined by CharAnalysis output, in Fig_3_script.m.
    nHSCF = length(HSCFin);               % sample size for HSCF      
    HSCF = [161 960 1243 2124 2670 2752 2913 3262 3725 3803 4156]; 
    % [cal yr BP] High-severity catchment fires (n = 11). Based on output 
    % from Fig_3_script.m and altered manually for more precise fire yr.
    % Used for Fig. 6

LSEF_hiResIn = [30 59 170 194 224 257 318 346 393];  % Index for 
        % LSEF_hiRes, defined by CharAnalysis output, in Fig_4_5_script.m.
    nLSEF_hiRes = length(LSEF_hiResIn);   % sample size for LSEF_hiRes
    LSEF_hiRes = [230 521 1637 1875 2177 2508 3116 3396 3863];
    % [cal yr BP] Lower severity, extra local fires (LSEF) with high 
    % resolution analysis (n = 9)
    % Used for Fig. S4
    
%% Create event series equal in length to interpolated series 
events = zeros(length(response.xi),2); % Space for binary
    % event series, where 1 = event, and 0 = no event, First row = HSFC, 
    % second row = LSEF_hiRes
for i = 1:nHSCF
    in = find(abs(response.xi - HSCF(i)) ==...
            min(abs(response.xi(:,1) - HSCF(i)))); % Find the index value
        % that minimizes the difference between the year of the event and
        % the closest matching year in the interpolated response series. 
        % This accommodates event and response series with differing x 
        % values. 
       events(in,1) = 1;     % Make this value 1
end
for i = 1:nLSEF_hiRes
    in = find(abs(response.xi - LSEF_hiRes(i)) ==...
            min(abs(response.xi - LSEF_hiRes(i)))); % Find the index 
        % value that minimizes the difference between the year of the event
        % and the closest matching year in the interpolated response 
        % series. This accommodates event and response series with differing 
        % x values. 
       events(in,2) = 1;     % Make this value 1
end

%% Create series for correlations, HSCF

x = peakMag(HSCFin);    % [#/cm^2] Peak magnitude, for peaks associated 
                        % with high severity catchment fires. 

y = NaN(length(x),response.n,2);    % Space for response variables, where 
                        % i = average response to each event, and j = 
                        % temporal window (0-20 yr for j = 1, 20-50 for 
                        % j = 3). 
responseIn = find(events(:,1)); % Index for events, in response variables.
eventBin1 = [-3:0];     % Sampling window, 0-20 yr (negative = post-fire)
eventBin2 = [-9:-4];    % Sampling window, 20-50 yr post fire. 
for i = 1:length(x)
    in1 = [responseIn(i) + eventBin1];  % Index for 0-20 yr post fire
    in2 = [responseIn(i) + eventBin2];  % Index for 20-50 yr post fire
    y(i,:,1) = mean(response.residuals(in1,:));
    y(i,:,2) = mean(response.residuals(in2,:));
end

%% Create series for correlations, LSEF_hiRes

x2 = peakMag(LSEF_hiResIn); % [#/cm^2] Peak magnitude, for peaks associated 
                            % with lower severity, extra local fires. 

y2 = NaN(length(x2),response.n,2);    % Space for response variables, where 
                        % i = average response to each event, and j = 
                        % temporal window (0-20 yr for j = 1, 20-50 for 
                        % j = 3). 
responseIn = find(events(:,2)); % Index for events, in response variables.
eventBin1 = [-3:0];     % Sampling window, 0-20 yr (negative = post-fire)
eventBin2 = [-9:-4];    % Sampling window, 20-50 yr post fire. 
for i = 1:length(x2)
    in1 = [responseIn(i) + eventBin1];  % Index for 0-20 yr post fire
    in2 = [responseIn(i) + eventBin2];  % Index for 20-50 yr post fire
    y2(i,:,1) = mean(response.residuals(in1,:));
    y2(i,:,2) = mean(response.residuals(in2,:));
end

%% Plot results
fs = 10;                        % Font size for figures
subplotIn = [1:2:response.n*2]; % Index for subplots

for k = 1:2             % For HSCF and for LSEF_hiRes
    if k == 1
        figure(6) 
        set(gcf,'color','w','units','centimeters','position',[5 0 11 20]); 
        xPlot = x;
        yPlot = y;
        x_lim = ([1 10000]);            % x-axis limit
        x_tick = [1 100 10000];         % x-axis tick marks
    else
        figure(7) 
        set(gcf,'color','w','units','centimeters','position',[5 0 11 20]); 
        xPlot = x2;
        yPlot = y2;
        x_lim = ([1 100]);              % x-axis limit
        x_tick = [1 10 100];            % x-axis tick marks
    end
    
for j = 1:response.n    % For each response variable...
    for i = 1:2         % For each time window post fire...
        % Select subplot
        if i == 1
            subplot(response.n,2,subplotIn(j))
        else
            subplot(response.n,2,subplotIn(j)+1)
        end
        
        % Pearson correlation coefficient for x vs. y: 
        [rho,p] = corr(log(xPlot),yPlot(:,j,i));
        b = regress(yPlot(:,j,i),[ones(size(xPlot)),log(xPlot)]);
        xHat = [min(log(xPlot)), max(log(xPlot))];  % Predicted x-values
        yHat = b(1) + b(2).*xHat;           % Predicted y-values 
        
        % Plot x and y, with x-axis on log scale:
        semilogx(xPlot,yPlot(:,j,i),'ok')
        hold on
        if p < 0.05 % If correlation is significant, plot best-fit line
            semilogx(exp(xHat),yHat,'-k')
        end
        
        % Set axis properties:
        y_lim = [min(yPlot(:,j,i))-0.25*range(yPlot(:,j,i))...
            max(yPlot(:,j,i))+0.25*range(yPlot(:,j,i))];
        set(gca,'xtick',x_tick,'ylim',y_lim,...
            'FontSize',fs','FontWeight','bold','tickdir','out',...
            'ticklength',[0.05 0.1],'xlim',x_lim)
        y_tick = get(gca,'ytick');
        if length(y_tick) > 3
            y_tick = [min(y_tick) min(y_tick)+0.5*range(y_tick) max(y_tick)];
            set(gca,'ytick',y_tick)
        end
        axis square
        box off
        
        % Titles and labels:
        title({['r = ' num2str(round(rho*100)/100) '; p = ' num2str(round(p*1000)/1000)]},...
            'FontSize', fs-2)
        if i == 1
            ylabel(response.name(j),'fontsize',fs,'FontWeight','Bold')
        end
        if j < response.n
            set(gca,'xticklabel',' ','FontWeight','Bold')
        end
        % Change size of subplot:
        p = get(gca,'position');
        p(4) = p(4)+0.0025;
        p(3) = 0.3347;
        if i == 1
            p(1) = p(1)+0.075;
        end
        set(gca,'position',p);
    
        % Place column title above row 1
        if j == 1
            if i == 1
                text(x_lim(1),y_lim(2)+0.4*range(y_lim),...
                    '0-20 yr postfire','HorizontalAlignment',...
                    'Left','FontSize',fs,'FontWeight','bold');
            else
                text(x_lim(1),y_lim(2)+0.4*range(y_lim),...
                    '20-50 yr postfire','HorizontalAlignment',...
                    'Left','FontSize',fs,'FontWeight','bold');
            end
        end      
    end     % End loop for each time window
end         % End loop for each variable
xlabel('Charcoal peak magnitude (# cm^{-2})                                          ',...
    'FontSize',fs,'FontWeight','b')
end

##### SOURCE END #####
--></body></html>